- if @show_new_selection_message
  .fr-alert.fr-alert--info.fr-mb-4w
    %pfr-alert__title= t("campaigns.edit_recipients_tooltip")

%p.fr-mb-4w= "Liste des #{campaign.available_communes.load.size} communes abritant des objets <abbr title='Monuments Historiques'>MH</abbr> #{campaign.departement.dans_nom}.".html_safe

= form_for campaign, builder: FormBuilderDsfr, url: send("#{routes_prefix}_campaign_update_recipients_path", campaign), data: { controller: "multichecker" } do |f|
  %ul.fr-btns-group.fr-btns-group--icon-left.fr-btns-group--inline-md.fr-mb-4w
    %li
      %button.fr-btn.fr-btn--secondary.fr-btn--icon-left.fr-icon-check-line{"data-action" => "multichecker#checkAll"}
        Tout sélectionner
    %li
      %button.fr-btn.fr-btn--tertiary.fr-btn--icon-left.fr-icon-close-line{"data-action" => "multichecker#uncheckAll"}
        Tout désélectionner
    %li.fr-ml-auto
      %button.fr-btn.fr-btn--primary.fr-btn--icon-left.fr-icon-checkbox-circle-fill{type: :submit} Enregistrer la sélection

  %fieldset.fr-fieldset
    %legend.fr-sr-only
      Communes
    .co-columns-auto.co-columns-sm-2.co-columns-md-3.co-columns-lg-4.fr-mx-1w
      - campaign.available_communes.each do |commune|
        - checked = campaign.commune_ids.include?(commune.id)
        - input_id = "campaign_recipients_attributes_commune_#{commune.id}"
        .fr-checkbox-group.fr-checkbox-group--sm.fr-mb-1w.co-break-avoid-column
          %input{type: :checkbox,
            name: "campaign[recipients_attributes][][commune_id]",
            id: input_id,
            value: commune.id,
            checked: checked,
            "data-multichecker-target": :checkbox,
            disabled: commune.users_count.zero? || commune.dossier&.construction? }
          %label.fr-label{for: input_id}
            %span.fr-mr-auto= commune.nom
            - if commune.users_count.zero?
              = badge(:warning) { "Pas d'email" }
            - elsif commune.dossier
              - if commune.dossier.construction?
                = badge { commune.dossier.aasm.human_state }
              - elsif commune.dossier.accepted?
                = badge(:success) { commune.dossier.aasm.human_state }
              - else
                = badge(:info) { commune.dossier.aasm.human_state }

  .fr-mt-4w.co-text--center
    %button.fr-btn.fr-btn--primary.fr-btn--icon-left.fr-icon-checkbox-circle-fill{type: :submit} Enregistrer la sélection
